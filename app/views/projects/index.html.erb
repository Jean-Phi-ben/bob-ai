<div class="container py-4" style="min-height: 100vh;">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10" data-controller="chat">

      <!-- Header -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h4 class="mb-1">üí¨ <%= @project.title %></h4>
          <p class="small text-muted mb-0">
            <%= @project.category.presence || "No category" %> ¬∑ AI project assistant
          </p>
        </div>
        <%= link_to "Back", projects_path, class: "btn btn-sm btn-outline-secondary" %>
      </div>

      <!-- Carte de chat -->
      <div class="card shadow-sm border-0" style="height: 70vh; display: flex; flex-direction: column;">

        <!-- Messages -->
        <div class="card-body px-3 py-3"
             data-chat-target="messages"
             style="overflow-y: auto; background: #f5f5f7; flex: 1 1 auto;">

          <% if @messages.any? %>
            <% @messages.each do |message| %>
              <% if message.role == "ai" %>
                <div class="d-flex mb-3">
                  <div class="me-2">
                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center"
                         style="width: 28px; height: 28px;">
                      <span class="text-white small fw-bold">AI</span>
                    </div>
                  </div>
                  <div>
                    <div class="small text-muted mb-1">Assistant</div>
                    <div class="p-3 rounded-3 bg-white border"
                         style="max-width: 80%; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
                      <%= simple_format(message.content) %>
                    </div>
                  </div>
                </div>
              <% else %>
                <div class="d-flex justify-content-end mb-3">
                  <div class="text-end">
                    <div class="small text-muted mb-1">You</div>
                    <div class="p-3 rounded-3 text-white"
                         style="max-width: 80%; background: linear-gradient(135deg,#4F46E5,#6366F1); box-shadow: 0 1px 3px rgba(0,0,0,0.15);">
                      <%= simple_format(message.content) %>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="h-100 d-flex flex-column justify-content-center align-items-center text-center text-muted">
              <div class="mb-2" style="font-size: 2.2rem;">üõ†Ô∏è</div>
              <p class="mb-0">
                No conversation yet.<br>
                Ask Bob something about this project to get started.
              </p>
            </div>
          <% end %>
        </div>

        <!-- Form -->
        <div class="card-footer bg-white border-0 px-3 pb-3 pt-2">
          <%= form_with model: [@project, @message],
                        data: {
                          action: "turbo:submit-start->chat#start turbo:submit-end->chat#end"
                        } do |f| %>
            <div class="input-group">
              <%= f.text_area :content,
                    rows: 1,
                    class: "form-control",
                    placeholder: "Ask Bob for help on this project...",
                    style: "resize:none;",
                    data: { chat_target: "input", action: "input->chat#resize" } %>
              <button class="btn btn-primary" type="submit" data-chat-target="button">
                Send
              </button>
            </div>
            <div class="form-text mt-1">
              Bob can help with tools, materials, steps & safety.
            </div>
          <% end %>
        </div>
      </div>

    </div>
  </div>
</div>
