<!-- VANTA BACKGROUND -->
<div id="vanta-bg" style="
  position: fixed;
  inset: 0;
  z-index: -1;
"></div>

<!-- OVERLAY lÃ©ger pour lisibilitÃ© -->
<div style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  z-index: -1;
"></div>


<!-- FULL TRANSPARENT CHAT -->
<div class="container py-4" style="max-width: 900px;">

  <!-- TITLE -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 style="color: white; font-size: 26px; font-weight: 700; margin: 0;">
        <%= @project.title %>
      </h1>
      <p style="color: #cbd5e1; font-size: 13px; margin: 0;">
        Discussion avec BOB.AI sur ce projet
      </p>
    </div>

    <%= link_to "Back to projects", projects_path,
         class: "btn btn-outline-light btn-sm rounded-pill px-3" %>
  </div>


  <!-- CHAT MESSAGES (FULL TRANSPARENT CONTAINER) -->
  <div id="messages" style="
    height: 70vh;
    overflow-y: auto;
    padding: 8px 4px;
  ">

    <% @project.messages.each do |message| %>

      <% if message.role == "user" %>
        <!-- USER MESSAGE -->
        <div class="d-flex justify-content-end mb-2">
          <div style="
            max-width: 70%;
            background: rgba(79,70,229,0.70);
            backdrop-filter: blur(8px);
            padding: 12px 16px;
            color: white;
            border-radius: 16px 16px 4px 16px;
            font-size: 14px;
            line-height: 1.45;
            box-shadow: 0 6px 20px rgba(79,70,229,0.45);
          ">
            <%= raw(render_markdown(message.content)) %>
          </div>
        </div>

      <% else %>
        <!-- ASSISTANT MESSAGE -->
        <div class="d-flex justify-content-start mb-3">
          <div style="
            max-width: 75%;
            background: rgba(2,6,23,0.35);
            border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(14px);
            padding: 12px 16px;
            color: #e5e7eb;
            border-radius: 16px 16px 16px 4px;
            font-size: 14px;
            line-height: 1.45;
          ">
            <div style="font-size: 11px; color: #a5b4fc; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px;">
              BOB.AI
            </div>

            <%= raw(render_markdown(message.content)) %>
          </div>
        </div>
      <% end %>

    <% end %>

    <% if @project.messages.empty? %>
      <p style="color: #cbd5e1; font-size: 14px; text-align: center; margin-top: 20px;">
        Aucun message pour lâ€™instant. Commence la conversation avec BOB.AI ðŸ‘‡
      </p>
    <% end %>

  </div>


  <!-- MESSAGE INPUT -->
  <div class="mt-3">
    <%= form_with model: [@project, Message.new], local: true do |f| %>

      <%= f.text_area :content,
            rows: 3,
            placeholder: "Write your messageâ€¦",
            class: "form-control",
            style: "
              background: rgba(0,0,0,0.35);
              color: white;
              border: 1px solid rgba(255,255,255,0.25);
              border-radius: 14px;
              backdrop-filter: blur(12px);
              resize: vertical;
            " %>

      <div class="d-flex justify-content-between align-items-center mt-2">
        <%= link_to 'Back', projects_path,
              class: 'btn btn-outline-light btn-sm rounded-pill px-3' %>

        <%= f.submit "Send",
              class: "btn btn-primary btn-sm rounded-pill px-4",
              style: "box-shadow: 0 4px 14px rgba(79,70,229,0.6);" %>
      </div>
    <% end %>
  </div>

</div>


<!-- VANTA HALO SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.halo.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  if (window.VANTA) {
    window.VANTA.HALO({
      el: "#vanta-bg",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      minHeight: 200.00,
      minWidth: 200.00,
      amplitudeFactor: 2.60,
      xOffset: 0.26
    });
  }
});
</script>
